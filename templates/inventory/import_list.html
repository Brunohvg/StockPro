{% extends 'base.html' %}
{% load humanize %}
{% load core_tags %}

{% block extra_css %}
<style>
    :root {
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(255, 255, 255, 0.4);
        --premium-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
        --accent-indigo: #6366f1;
    }

    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 1.5rem;
        box-shadow: var(--premium-shadow);
    }

    .stat-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: default;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        background: white;
    }

    .status-badge {
        font-weight: 700;
        letter-spacing: 0.025em;
        padding: 0.4rem 0.8rem;
        border-radius: 0.75rem;
        font-size: 0.55rem;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .status-completed { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; }
    .status-processing { background: #eef2ff; color: #4f46e5; border: 1px solid #e0e7ff; }
    .status-error { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }
    .status-pending { background: #fffbeb; color: #d97706; border: 1px solid #fef3c7; }

    .table-row-hover {
        transition: all 0.2s ease;
    }

    .table-row-hover:hover {
        background-color: rgba(241, 245, 249, 0.4);
    }

    .custom-checkbox {
        width: 1.1rem;
        height: 1.1rem;
        border-radius: 0.4rem;
        border: 2px solid #e2e8f0;
        transition: all 0.2s;
    }

    .custom-checkbox:checked {
        background-color: var(--accent-indigo);
        border-color: var(--accent-indigo);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-[9px] font-bold uppercase tracking-widest border border-indigo-100">Enterprise Data Suite</span>
                <span class="text-slate-400 text-[9px] font-bold uppercase tracking-widest">Logs de Ingestão</span>
            </div>
            <h1 class="text-4xl font-black text-slate-900 tracking-tight">Monitor de Importações</h1>
            <p class="text-slate-500 mt-2 text-base font-medium max-w-xl">Gerenciamento centralizado de importações assistidas por inteligência V3.</p>
        </div>

        <div class="flex items-center gap-3">
            <a href="{% url 'inventory:import_create' %}" class="flex items-center gap-2 px-6 py-3 bg-slate-900 hover:bg-indigo-600 text-white rounded-2xl font-bold transition-all shadow-lg shadow-slate-900/10 active:scale-95 group text-sm">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Nova Importação
            </a>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="glass-card stat-card p-6 relative overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 bg-indigo-50 rounded-xl flex items-center justify-center text-indigo-600">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                </div>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Total Geral</span>
            </div>
            <div class="text-3xl font-black text-slate-900 tracking-tight">{{ imports|length }}</div>
            <div class="text-[10px] text-slate-400 font-bold mt-1">Lotes Carregados</div>
        </div>

        <div class="glass-card stat-card p-6 relative overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600">
                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                </div>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Sucesso</span>
            </div>
            <div class="text-3xl font-black text-slate-900 tracking-tight">{{ completed_count }}</div>
            <div class="text-[10px] text-slate-400 font-bold mt-1">Concluídas</div>
        </div>

        <div class="glass-card stat-card p-6 relative overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 bg-amber-50 rounded-xl flex items-center justify-center text-amber-600">
                    <i data-lucide="refresh-cw" class="w-5 h-5 animate-spin-slow"></i>
                </div>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Ativos</span>
            </div>
            <div class="text-3xl font-black text-slate-900 tracking-tight">{% with processing=imports|select_attr:"status"|equalto:"PROCESSING"|length %}{{ processing|default:0 }}{% endwith %}</div>
            <div class="text-[10px] text-slate-400 font-bold mt-1">Em Processamento</div>
        </div>

        <div class="glass-card stat-card p-6 relative overflow-hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="w-10 h-10 bg-rose-50 rounded-xl flex items-center justify-center text-rose-600">
                    <i data-lucide="alert-octagon" class="w-5 h-5"></i>
                </div>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Falhas</span>
            </div>
            <div class="text-3xl font-black text-slate-900 tracking-tight">{{ error_count }}</div>
            <div class="text-[10px] text-slate-400 font-bold mt-1">Necessitam Revisão</div>
        </div>
    </div>

    <!-- Main Content Table -->
    <div class="glass-card overflow-hidden">
        <form id="bulkForm" method="post" action="{% url 'inventory:bulk_delete_imports' %}">
            {% csrf_token %}
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/20">
                            <th class="px-6 py-4">
                                <input type="checkbox" id="selectAll" class="custom-checkbox focus:ring-indigo-500 text-indigo-600">
                            </th>
                            <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Referência</th>
                            <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Tipo</th>
                            <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Status</th>
                            <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Data</th>
                            <th class="px-6 py-4 text-right text-[10px] font-bold text-slate-400 uppercase tracking-widest">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for imp in imports %}
                        <tr class="group table-row-hover" id="import-table-row-{{ imp.id }}"
                            {% if imp.status == 'PROCESSING' or imp.status == 'PENDING' %}
                            hx-get="{% url 'inventory:import_list' %}"
                            hx-trigger="every 10s"
                            hx-select="#import-table-row-{{ imp.id }}"
                            hx-target="#import-table-row-{{ imp.id }}"
                            hx-swap="outerHTML"
                            {% endif %}>

                            <td class="px-6 py-4">
                                <input type="checkbox" name="import_ids" value="{{ imp.id }}" class="import-checkbox custom-checkbox focus:ring-indigo-500 text-indigo-600">
                            </td>

                            <td class="px-6 py-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-indigo-600 group-hover:text-white transition-all duration-300">
                                        <i data-lucide="file-{% if 'XML' in imp.type %}code{% else %}table{% endif %}" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-slate-900 group-hover:text-indigo-600 transition-colors">#{{ imp.id|stringformat:".8s" }}</div>
                                        <div class="text-[10px] text-slate-400 font-medium truncate max-w-[150px]">{{ imp.file.name|basename }}</div>
                                    </div>
                                </div>
                            </td>

                            <td class="px-6 py-4 text-center">
                                <span class="px-2 py-1 bg-slate-100 text-slate-500 rounded-lg text-[9px] font-bold uppercase tracking-widest border border-slate-200">
                                    {{ imp.get_type_display }}
                                </span>
                            </td>

                            <td class="px-6 py-4">
                                <div class="flex flex-col gap-2 min-w-[180px]">
                                    <div class="flex items-center justify-between">
                                        <span class="status-badge
                                            {% if imp.status == 'COMPLETED' %}status-completed
                                            {% elif imp.status == 'PROCESSING' %}status-processing
                                            {% elif imp.status == 'ERROR' %}status-error
                                            {% else %}status-pending{% endif %}">
                                            {% if imp.status == 'PROCESSING' %}<i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i>{% endif %}
                                            {{ imp.get_status_display }}
                                        </span>
                                        {% if imp.status == 'PROCESSING' %}
                                        <span class="text-[9px] font-bold text-indigo-600">{{ imp.progress_percent }}%</span>
                                        {% endif %}
                                    </div>

                                    {% if imp.status == 'PROCESSING' %}
                                    <div class="w-full h-1 bg-slate-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-indigo-500 transition-all duration-1000" style="width: {{ imp.progress_percent }}%"></div>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>

                            <td class="px-6 py-4">
                                <div class="text-xs font-bold text-slate-900">{{ imp.created_at|date:"d M, Y" }}</div>
                                <div class="text-[9px] text-slate-400 uppercase font-medium">{{ imp.created_at|date:"H:i" }}</div>
                            </td>

                            <td class="px-6 py-4 text-right">
                                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all">
                                    <a href="{% url 'inventory:import_detail' imp.id %}" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-lg transition-all" title="Ver Detalhes">
                                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                                    </a>

                                    {% if imp.status != 'COMPLETED' and imp.status != 'PROCESSING' %}
                                    <a href="{% url 'inventory:import_reprocess' imp.id %}" class="p-2 text-slate-400 hover:text-amber-600 hover:bg-slate-50 rounded-lg transition-all" title="Reprocessar">
                                        <i data-lucide="play-circle" class="w-5 h-5"></i>
                                    </a>
                                    {% endif %}

                                    <button type="button"
                                            onclick="confirmDelete('{{ imp.id }}')"
                                            class="p-2 text-slate-400 hover:text-rose-600 hover:bg-slate-50 rounded-lg transition-all" title="Excluir">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-24 text-center">
                                <div class="max-w-xs mx-auto">
                                    <div class="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-200 mx-auto mb-6">
                                        <i data-lucide="database-zap" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">Sem importações</h3>
                                    <p class="text-slate-500 text-sm">O sistema aguarda o upload de planilhas ou NF-e.</p>
                                    <a href="{% url 'inventory:import_create' %}" class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold mt-6 hover:bg-indigo-700 transition-all text-sm">
                                        Iniciar Importação
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Floating Footer Actions -->
            <div id="actionBar" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-8 opacity-0 translate-y-10 pointer-events-none transition-all duration-500 z-50">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center font-bold text-lg" id="selectedCountDisplay">0</div>
                    <div class="text-sm font-bold">Selecionados</div>
                </div>
                <div class="h-8 w-px bg-white/10"></div>
                <div class="flex items-center gap-4">
                    <button type="submit"
                            onclick="return confirm('Excluir registros selecionados?')"
                            class="px-5 py-2.5 bg-rose-600 hover:bg-rose-700 text-white rounded-xl font-bold transition-all text-sm">
                        Excluir Seleção
                    </button>
                    <button type="button" onclick="clearSelection()" class="px-5 py-2.5 bg-white/5 hover:bg-white/10 text-white rounded-xl font-bold transition-all text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Hidden form for single delete -->
    <form id="singleDeleteForm" method="post" class="hidden">
        {% csrf_token %}
    </form>
</div>

<script>
    lucide.createIcons();

    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.import-checkbox');
    const actionBar = document.getElementById('actionBar');
    const selectedCountDisplay = document.getElementById('selectedCountDisplay');

    function updateActionBar() {
        const checked = document.querySelectorAll('.import-checkbox:checked').length;
        selectedCountDisplay.textContent = checked;

        if (checked > 0) {
            actionBar.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            actionBar.classList.add('opacity-100', 'translate-y-0');
        } else {
            actionBar.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            actionBar.classList.remove('opacity-100', 'translate-y-0');
        }
    }

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateActionBar();
        });
    }

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateActionBar);
    });

    function clearSelection() {
        checkboxes.forEach(cb => cb.checked = false);
        if (selectAll) selectAll.checked = false;
        updateActionBar();
    }

    function confirmDelete(id) {
        if (confirm('Deseja excluir este registro?')) {
            const form = document.getElementById('singleDeleteForm');
            form.action = `/inventory/import/${id}/delete/`;
            form.submit();
        }
    }
</script>
{% endblock %}
